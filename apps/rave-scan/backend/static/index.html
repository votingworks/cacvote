<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="/output.css" />
</head>
<body>
  <div class="h-screen w-screen flex justify-center items-center">
    <div class="flex-col">
      <div class="flex-row mb-2">
        <button
          class="scan-button rounded-lg text-3xl bg-purple-500 active:bg-purple-700 disabled:bg-purple-300 text-white p-5 mr-2"
        >
          Scan Ballots
        </button>
        <button
          class="sync-button rounded-lg text-3xl bg-purple-500 active:bg-purple-700 disabled:bg-purple-300 text-white p-5 mr-2"
        >
          Sync with Server
        </button>
      </div>
      <div>
        <div class="text-2xl text-center text-gray-500">
          <span class="total-scanned-ballots-count">0</span>
          total scanned ballot(s)
          (<span class="pending-scanned-ballots-count">0</span> pending)
        </div>
      </div>
  </div>

  <script type="text/javascript">
    const scanButton = document.getElementsByClassName('scan-button')[0];
    scanButton.addEventListener('click', async (event) => {
      const oldTextContent = scanButton.textContent;
      scanButton.textContent = 'Scanning…';
      scanButton.disabled = true;

      try {
        const response = await fetch('/api/scan', { method: 'POST' });
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }

        const json = await response.json();
      } catch (error) {
        alert(error.message);
      } finally {
        scanButton.textContent = oldTextContent;
        scanButton.disabled = false;
      }
    });

    const syncButton = document.getElementsByClassName('sync-button')[0];
    let scannedBallotStats = {
      total: 0,
      pending: 0,
    };
    let totalScannedBallotsSyncCount = 0;
    let pendingScannedBallotsSyncCount = 0;
    let isSyncing = false;

    syncButton.addEventListener('click', async (event) => {
      const oldTextContent = syncButton.textContent;
      isSyncing = true;
      syncButton.textContent = 'Syncing…';
      syncButton.disabled = true;

      try {
        const response = await fetch('/api/sync', { method: 'POST' });
        if (!response.ok) {
          throw new Error('Network response was not ok.');
        }

        const json = await response.json();
      } catch (error) {
        alert(error.message);
      } finally {
        isSyncing = false;
        syncButton.textContent = oldTextContent;
        syncButton.disabled = false;
      }
    });

    const totalScannedBallotsCountSpan = document.getElementsByClassName(
      'total-scanned-ballots-count'
    )[0];
    const pendingScannedBallotsCountSpan = document.getElementsByClassName(
      'pending-scanned-ballots-count'
    )[0];
    const statusStream = new EventSource('/api/status-stream');
    statusStream.addEventListener('message', (event) => {
      const json = JSON.parse(event.data);
      scannedBallotStats = json.stats;
      totalScannedBallotsCountSpan.textContent = scannedBallotStats.total;
      pendingScannedBallotsCountSpan.textContent = scannedBallotStats.pending;
    });
  </script>
</body>
